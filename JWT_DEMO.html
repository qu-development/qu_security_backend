<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo JWT Permissions System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .login-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .login-        // Mostrar mensaje inicial
        showStatus('üöÄ ¬°Demo REAL conectado al backend! Usa credenciales reales para hacer login.', 'success');rm input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .permission-card {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            background: #f8f9fa;
        }
        .permission-card h3 {
            margin-top: 0;
            color: #333;
        }
        .permission-list {
            list-style: none;
            padding: 0;
        }
        .permission-list li {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .permission-list li:last-child {
            border-bottom: none;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .hidden {
            display: none;
        }
        .token-display {
            background: #f1f1f1;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            word-break: break-all;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Demo REAL Sistema JWT de Permisos</h1>
        <p>üöÄ Este demo se conecta REALMENTE con tu backend Django. Los datos y permisos son reales.</p>

        <!-- Formulario de Login -->
        <div id="login-section">
            <h2>Login</h2>
            <div class="login-form">
                <input type="text" id="username" placeholder="Usuario" value="demo_user">
                <input type="password" id="password" placeholder="Contrase√±a" value="demo123#">
                <button class="btn btn-primary" onclick="simulateLogin()">Login</button>
            </div>
            <p><small>Demo: <strong>demo_user / demo123#</strong> (usuario con permisos completos creado autom√°ticamente)</small></p>
        </div>

        <!-- Dashboard (oculto inicialmente) -->
        <div id="dashboard-section" class="hidden">
            <h2>Dashboard</h2>
            <div id="user-info"></div>
            <button class="btn btn-danger" onclick="logout()">Logout</button>
        </div>
    </div>

    <!-- Informaci√≥n de Permisos -->
    <div id="permissions-section" class="container hidden">
        <h2>üõ°Ô∏è Permisos del Usuario</h2>
        <div id="permissions-content"></div>
    </div>

    <!-- Acciones Disponibles -->
    <div id="actions-section" class="container hidden">
        <h2>üéØ Acciones Disponibles</h2>
        <div class="permissions-grid">
            <!-- Clientes -->
            <div class="permission-card">
                <h3>üë• Gesti√≥n de Clientes</h3>
                <button class="btn btn-success" id="btn-create-client" onclick="simulateAction('create-client')">Crear Cliente</button>
                <button class="btn btn-secondary" id="btn-read-client" onclick="simulateAction('read-client')">Ver Clientes</button>
                <button class="btn btn-primary" id="btn-update-client" onclick="simulateAction('update-client')">Editar Cliente</button>
                <button class="btn btn-danger" id="btn-delete-client" onclick="simulateAction('delete-client')">Eliminar Cliente</button>
            </div>

            <!-- Guardias -->
            <div class="permission-card">
                <h3>üõ°Ô∏è Gesti√≥n de Guardias</h3>
                <button class="btn btn-success" id="btn-create-guard" onclick="simulateAction('create-guard')">Crear Guardia</button>
                <button class="btn btn-secondary" id="btn-read-guard" onclick="simulateAction('read-guard')">Ver Guardias</button>
                <button class="btn btn-primary" id="btn-assign-guard" onclick="simulateAction('assign-guard')">Asignar Guardia</button>
                <button class="btn btn-primary" id="btn-update-guard" onclick="simulateAction('update-guard')">Editar Guardia</button>
            </div>

            <!-- Gastos -->
            <div class="permission-card">
                <h3>üí∞ Gesti√≥n de Gastos</h3>
                <button class="btn btn-success" id="btn-create-expense" onclick="simulateAction('create-expense')">Crear Gasto</button>
                <button class="btn btn-secondary" id="btn-read-expense" onclick="simulateAction('read-expense')">Ver Gastos</button>
                <button class="btn btn-primary" id="btn-approve-expense" onclick="simulateAction('approve-expense')">Aprobar Gasto</button>
                <button class="btn btn-primary" id="btn-update-expense" onclick="simulateAction('update-expense')">Editar Gasto</button>
            </div>

            <!-- Propiedades -->
            <div class="permission-card">
                <h3>üè¢ Acceso a Propiedades</h3>
                <div id="properties-list"></div>
            </div>
        </div>
    </div>

    <!-- Administraci√≥n de Permisos (solo admin) -->
    <div id="admin-section" class="container hidden">
        <h2>üõ†Ô∏è Administraci√≥n de Permisos</h2>
        <p>Esta secci√≥n solo es visible para usuarios con permisos de administrador.</p>

        <!-- Panel de gesti√≥n de permisos del usuario actual -->
        <div class="permission-card">
            <h3>‚ö° Gesti√≥n de Permisos</h3>
            <p>Modifica los permisos del usuario actual: <strong id="current-user-display"></strong></p>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <!-- Permisos de Recursos -->
                <div>
                    <h4>üìã Permisos de Recursos</h4>
                    <div id="resource-permissions-grid" style="background: #f8f9fa; padding: 15px; border-radius: 6px; border: 1px solid #ddd;">
                        <p>Cargando permisos...</p>
                    </div>
                    <div style="margin-top: 15px; text-align: center;">
                        <button class="btn btn-primary" onclick="saveResourcePermissions()">üíæ Guardar Cambios de Recursos</button>
                    </div>
                </div>

                <!-- Acceso a Propiedades -->
                <div>
                    <h4>üè¢ Acceso a Propiedades</h4>
                    <div id="property-permissions-grid" style="background: #f8f9fa; padding: 15px; border-radius: 6px; border: 1px solid #ddd;">
                        <p>Cargando propiedades...</p>
                    </div>
                    <div style="margin-top: 15px; text-align: center;">
                        <button class="btn btn-primary" onclick="savePropertyPermissions()">üè† Guardar Cambios de Propiedades</button>
                    </div>
                </div>
            </div>

            <!-- Bot√≥n para refrescar permisos -->
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-success" onclick="refreshUserPermissions()">üîÑ Refrescar & Relogin</button>
                <p><small>Despu√©s de modificar permisos, haz clic aqu√≠ para obtener un nuevo token con los permisos actualizados.</small></p>
            </div>
        </div>

        <!-- Log de cambios -->
        <div class="permission-card">
            <h3>üìú Log de Cambios de Permisos</h3>
            <div id="permission-log" style="max-height: 300px; overflow-y: auto;">
                <p>Los cambios de permisos aparecer√°n aqu√≠...</p>
            </div>
        </div>
    </div>

    <!-- Token JWT -->
    <div id="token-section" class="container hidden">
        <h2>üîë Token JWT Decodificado</h2>
        <p>Este es el contenido del token JWT que recibir√≠a el frontend:</p>
        <div id="token-display" class="token-display"></div>
    </div>

    <script>
        // Configuraci√≥n de la API
        const API_BASE_URL = 'https://wr60a2rc2j.execute-api.us-east-2.amazonaws.com/dev/en/api';

        let currentUser = null;
        let currentTokens = null;

        // Funci√≥n para decodificar JWT (versi√≥n simple sin librer√≠a externa)
        function decodeJWT(token) {
            try {
                const parts = token.split('.');
                const payload = parts[1];
                const decoded = atob(payload.replace(/-/g, '+').replace(/_/g, '/'));
                return JSON.parse(decoded);
            } catch (error) {
                console.error('Error decoding JWT:', error);
                return null;
            }
        }

        // Clase PermissionHelper que funciona con tokens JWT reales
        class PermissionHelper {
            constructor(tokenData) {
                this.decoded = tokenData;
            }

            getUsername() {
                return this.decoded.username;
            }

            getRole() {
                return this.decoded.role;
            }

            isAdmin() {
                return this.decoded.is_admin || this.decoded.is_superuser;
            }

            hasResourcePermission(resourceType, action) {
                const permissions = this.decoded.resource_permissions[resourceType] || [];
                return permissions.includes(action);
            }

            canAccessProperty(propertyId) {
                return this.decoded.accessible_properties.includes(propertyId);
            }

            getAccessibleProperties() {
                return this.decoded.accessible_properties || [];
            }

            // M√©todos espec√≠ficos
            canCreateClients() {
                return this.hasResourcePermission('client', 'create');
            }

            canReadClients() {
                return this.hasResourcePermission('client', 'read');
            }

            canUpdateClients() {
                return this.hasResourcePermission('client', 'update');
            }

            canDeleteClients() {
                return this.hasResourcePermission('client', 'delete');
            }

            canCreateGuards() {
                return this.hasResourcePermission('guard', 'create');
            }

            canReadGuards() {
                return this.hasResourcePermission('guard', 'read');
            }

            canAssignGuards() {
                return this.hasResourcePermission('guard', 'assign');
            }

            canUpdateGuards() {
                return this.hasResourcePermission('guard', 'update');
            }

            canCreateExpenses() {
                return this.hasResourcePermission('expense', 'create');
            }

            canReadExpenses() {
                return this.hasResourcePermission('expense', 'read');
            }

            canApproveExpenses() {
                return this.hasResourcePermission('expense', 'approve');
            }

            canUpdateExpenses() {
                return this.hasResourcePermission('expense', 'update');
            }
        }

        // Funci√≥n de login real que conecta con el backend
        async function simulateLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            console.log('üîÑ Iniciando login con:', username);
            showStatus('üîÑ Conectando con el backend...', 'success');

            try {
                const loginUrl = `${API_BASE_URL}/auth/login/`;
                console.log('üåê URL de login:', loginUrl);

                const response = await fetch(loginUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                console.log('üì° Respuesta del servidor:', response.status, response.statusText);

                if (response.ok) {
                    const tokens = await response.json();
                    console.log('üéØ Tokens recibidos:', tokens);
                    currentTokens = tokens;

                    // Decodificar el access token
                    const decodedToken = decodeJWT(tokens.access);
                    console.log('üîì Token decodificado:', decodedToken);

                    if (decodedToken) {
                        currentUser = new PermissionHelper(decodedToken);
                        showDashboard();
                        showPermissions();
                        updateActionButtons();
                        showToken();
                        showStatus('‚úÖ Login exitoso! Conectado al backend real', 'success');

                        // Cargar datos reales
                        await loadRealData();
                    } else {
                        showStatus('‚ùå Error decodificando el token', 'error');
                    }
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('‚ùå Error de login:', response.status, errorData);
                    showStatus(`‚ùå Error de login: ${errorData.detail || 'Credenciales inv√°lidas'}`, 'error');
                }
            } catch (error) {
                console.error('üí• Error de conexi√≥n:', error);
                showStatus(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
            }
        }

        // Funci√≥n para hacer peticiones autenticadas
        async function authenticatedFetch(url, options = {}) {
            if (!currentTokens) {
                throw new Error('No hay token de acceso');
            }

            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${currentTokens.access}`,
                ...options.headers
            };

            const response = await fetch(url, {
                ...options,
                headers
            });

            if (response.status === 401) {
                showStatus('‚ùå Token expirado o inv√°lido', 'error');
                logout();
                return null;
            }

            return response;
        }

        // Cargar datos reales del backend
        async function loadRealData() {
            console.log('üìä Iniciando carga de datos reales...');
            try {
                // Cargar clientes si tiene permisos
                if (currentUser.canReadClients()) {
                    console.log('üë• Cargando clientes...');
                    const response = await authenticatedFetch(`${API_BASE_URL}/clients/`);
                    if (response && response.ok) {
                        const clients = await response.json();
                        console.log('üë• Clientes cargados:', clients);
                        showStatus(`üìä Cargados ${clients.results ? clients.results.length : clients.length} clientes reales`, 'success');
                    }
                }

                // Cargar propiedades si tiene permisos
                console.log('üè¢ Cargando propiedades...');
                const response = await authenticatedFetch(`${API_BASE_URL}/properties/`);
                if (response && response.ok) {
                    const properties = await response.json();
                    console.log('üè¢ Propiedades cargadas:', properties);
                    showStatus(`üè¢ Cargadas ${properties.results ? properties.results.length : properties.length} propiedades reales`, 'success');
                }

                // Cargar guardias si tiene permisos
                if (currentUser.canReadGuards()) {
                    console.log('üõ°Ô∏è Cargando guardias...');
                    const response = await authenticatedFetch(`${API_BASE_URL}/guards/`);
                    if (response && response.ok) {
                        const guards = await response.json();
                        console.log('üõ°Ô∏è Guardias cargados:', guards);
                        showStatus(`üõ°Ô∏è Cargados ${guards.results ? guards.results.length : guards.length} guardias reales`, 'success');
                    }
                }

            } catch (error) {
                console.error('üí• Error loading real data:', error);
                showStatus(`‚ö†Ô∏è Error cargando datos: ${error.message}`, 'error');
            }
        }

        function logout() {
            currentUser = null;
            currentTokens = null;
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('dashboard-section').classList.add('hidden');
            document.getElementById('permissions-section').classList.add('hidden');
            document.getElementById('actions-section').classList.add('hidden');
            document.getElementById('token-section').classList.add('hidden');
            document.getElementById('admin-section').classList.add('hidden');
            showStatus('üëã Sesi√≥n cerrada', 'success');
        }

        // ===============================================
        // üõ†Ô∏è NUEVAS FUNCIONES DE ADMINISTRACI√ìN CON CHECKBOXES
        // ===============================================

        // Cargar datos de administraci√≥n
        async function loadAdminData() {
            console.log('üõ†Ô∏è Cargando datos de administraci√≥n...');
            await loadResourcePermissionsGrid();
            await loadPropertyPermissionsGrid();
        }

        // Cargar grid de permisos de recursos con checkboxes
        async function loadResourcePermissionsGrid() {
            try {
                const container = document.getElementById('resource-permissions-grid');

                // Obtener permisos actuales del usuario
                const response = await authenticatedFetch('/en/api/v1/permissions/admin/list_users_with_permissions/');
                if (!response || !response.ok) {
                    container.innerHTML = '<p>‚ùå Error cargando permisos</p>';
                    return;
                }

                const data = await response.json();
                const currentUserData = data.users.find(u => u.id == currentUser.decoded.user_id);

                // Crear mapa de permisos actuales
                const currentPermissions = {};
                if (currentUserData && currentUserData.resource_permissions) {
                    currentUserData.resource_permissions.forEach(perm => {
                        const key = `${perm.resource_type}.${perm.action}`;
                        currentPermissions[key] = perm.id;
                    });
                }

                // Definir todos los permisos posibles
                const resources = [
                    { id: 'client', name: 'üë• Clientes' },
                    { id: 'guard', name: 'üõ°Ô∏è Guardias' },
                    { id: 'expense', name: 'üí∞ Gastos' },
                    { id: 'shift', name: 'üïê Turnos' }
                ];

                const actions = [
                    { id: 'create', name: 'Crear' },
                    { id: 'read', name: 'Leer' },
                    { id: 'update', name: 'Actualizar' },
                    { id: 'delete', name: 'Eliminar' },
                    { id: 'approve', name: 'Aprobar' },
                    { id: 'assign', name: 'Asignar' }
                ];

                // Generar HTML con checkboxes
                let html = '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">';

                resources.forEach(resource => {
                    html += `
                        <div style="border: 1px solid #ddd; padding: 10px; border-radius: 4px; background: white;">
                            <h5 style="margin: 0 0 10px 0; color: #333;">${resource.name}</h5>
                    `;

                    actions.forEach(action => {
                        const key = `${resource.id}.${action.id}`;
                        const isChecked = currentPermissions[key] ? 'checked' : '';
                        const permissionId = currentPermissions[key] || '';

                        html += `
                            <label style="display: block; margin: 5px 0; cursor: pointer;">
                                <input type="checkbox"
                                       id="perm_${resource.id}_${action.id}"
                                       data-resource="${resource.id}"
                                       data-action="${action.id}"
                                       data-permission-id="${permissionId}"
                                       ${isChecked}
                                       style="margin-right: 8px;">
                                ${action.name}
                            </label>
                        `;
                    });

                    html += '</div>';
                });

                html += '</div>';
                container.innerHTML = html;

                console.log('‚úÖ Grid de permisos de recursos cargado');

            } catch (error) {
                console.error('‚ùå Error cargando grid de permisos:', error);
                document.getElementById('resource-permissions-grid').innerHTML = '<p>‚ùå Error cargando permisos</p>';
            }
        }

        // Cargar grid de permisos de propiedades con checkboxes
        async function loadPropertyPermissionsGrid() {
            try {
                const container = document.getElementById('property-permissions-grid');

                // Obtener propiedades disponibles
                const propertiesResponse = await authenticatedFetch(`${API_BASE_URL}/properties/`);
                if (!propertiesResponse || !propertiesResponse.ok) {
                    container.innerHTML = '<p>‚ùå Error cargando propiedades</p>';
                    return;
                }

                const properties = await propertiesResponse.json();
                const propList = properties.results || properties;

                // Obtener accesos actuales del usuario
                const userResponse = await authenticatedFetch('/en/api/v1/permissions/admin/list_users_with_permissions/');
                if (!userResponse || !userResponse.ok) {
                    container.innerHTML = '<p>‚ùå Error cargando accesos</p>';
                    return;
                }

                const userData = await userResponse.json();
                const currentUserData = userData.users.find(u => u.id == currentUser.decoded.user_id);

                // Crear mapa de accesos actuales
                const currentAccess = {};
                if (currentUserData && currentUserData.property_access) {
                    currentUserData.property_access.forEach(access => {
                        currentAccess[access.property_id] = access;
                    });
                }

                // Generar HTML con checkboxes para propiedades
                let html = '<div style="max-height: 300px; overflow-y: auto;">';

                if (propList.length === 0) {
                    html += '<p>‚ÑπÔ∏è No hay propiedades disponibles</p>';
                } else {
                    propList.forEach(property => {
                        const hasAccess = currentAccess[property.id];
                        const isChecked = hasAccess ? 'checked' : '';
                        const accessId = hasAccess ? hasAccess.id : '';
                        const accessType = hasAccess ? hasAccess.access_type : 'viewer';

                        html += `
                            <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 4px; background: white;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox"
                                           id="prop_${property.id}"
                                           data-property-id="${property.id}"
                                           data-access-id="${accessId}"
                                           ${isChecked}
                                           style="margin-right: 10px;">
                                    <div style="flex: 1;">
                                        <strong>üè† ${property.address}</strong><br>
                                        <small>ID: ${property.id}</small>
                                    </div>
                                    <div style="margin-left: 10px;">
                                        <select id="access_type_${property.id}"
                                                style="padding: 2px; font-size: 12px;"
                                                ${!hasAccess ? 'disabled' : ''}>
                                            <option value="viewer" ${accessType === 'viewer' ? 'selected' : ''}>üëÅÔ∏è Visor</option>
                                            <option value="editor" ${accessType === 'editor' ? 'selected' : ''}>‚úèÔ∏è Editor</option>
                                            <option value="admin" ${accessType === 'admin' ? 'selected' : ''}>üëë Admin</option>
                                            <option value="full" ${accessType === 'full' ? 'selected' : ''}>üîì Completo</option>
                                        </select>
                                    </div>
                                </label>
                            </div>
                        `;
                    });
                }

                html += '</div>';
                container.innerHTML = html;

                // Agregar event listeners para habilitar/deshabilitar selects
                propList.forEach(property => {
                    const checkbox = document.getElementById(`prop_${property.id}`);
                    const select = document.getElementById(`access_type_${property.id}`);

                    if (checkbox && select) {
                        checkbox.addEventListener('change', function() {
                            select.disabled = !this.checked;
                            if (!this.checked) {
                                select.value = 'viewer';
                            }
                        });
                    }
                });

                console.log('‚úÖ Grid de permisos de propiedades cargado');

            } catch (error) {
                console.error('‚ùå Error cargando grid de propiedades:', error);
                document.getElementById('property-permissions-grid').innerHTML = '<p>‚ùå Error cargando propiedades</p>';
            }
        }

        // Guardar cambios de permisos de recursos
        async function saveResourcePermissions() {
            try {
                showStatus('üîÑ Guardando cambios de permisos de recursos...', 'success');

                const checkboxes = document.querySelectorAll('#resource-permissions-grid input[type="checkbox"]');
                const changes = [];

                checkboxes.forEach(checkbox => {
                    const resource = checkbox.dataset.resource;
                    const action = checkbox.dataset.action;
                    const permissionId = checkbox.dataset.permissionId;
                    const isChecked = checkbox.checked;
                    const hadPermission = permissionId && permissionId !== '';

                    if (isChecked && !hadPermission) {
                        // Necesita otorgar permiso
                        changes.push({
                            type: 'grant',
                            resource_type: resource,
                            action: action
                        });
                    } else if (!isChecked && hadPermission) {
                        // Necesita revocar permiso
                        changes.push({
                            type: 'revoke',
                            permission_id: permissionId
                        });
                    }
                });

                console.log('üìù Cambios detectados:', changes);

                if (changes.length === 0) {
                    showStatus('‚ÑπÔ∏è No hay cambios que guardar', 'success');
                    return;
                }

                // Aplicar cambios
                let successCount = 0;
                let errorCount = 0;

                for (const change of changes) {
                    try {
                        if (change.type === 'grant') {
                            const response = await authenticatedFetch('/en/api/v1/permissions/admin/grant_resource_permission/', {
                                method: 'POST',
                                body: JSON.stringify({
                                    user_id: currentUser.decoded.user_id,
                                    resource_type: change.resource_type,
                                    action: change.action,
                                    reason: 'Otorgado desde interface de checkboxes'
                                })
                            });

                            if (response && response.ok) {
                                successCount++;
                                const result = await response.json();
                                logPermissionChange('granted', result);
                            } else {
                                errorCount++;
                                console.error('Error otorgando permiso:', change);
                            }
                        } else if (change.type === 'revoke') {
                            const response = await authenticatedFetch('/en/api/v1/permissions/admin/revoke_resource_permission/', {
                                method: 'POST',
                                body: JSON.stringify({
                                    permission_id: change.permission_id,
                                    reason: 'Revocado desde interface de checkboxes'
                                })
                            });

                            if (response && response.ok) {
                                successCount++;
                                const result = await response.json();
                                logPermissionChange('revoked', result);
                            } else {
                                errorCount++;
                                console.error('Error revocando permiso:', change);
                            }
                        }
                    } catch (error) {
                        errorCount++;
                        console.error('Error procesando cambio:', error, change);
                    }
                }

                if (errorCount === 0) {
                    showStatus(`‚úÖ Todos los cambios guardados exitosamente (${successCount} cambios)`, 'success');
                } else {
                    showStatus(`‚ö†Ô∏è ${successCount} cambios exitosos, ${errorCount} errores`, 'error');
                }

                // Recargar el grid para reflejar los cambios
                setTimeout(() => loadResourcePermissionsGrid(), 1000);

            } catch (error) {
                console.error('‚ùå Error guardando permisos de recursos:', error);
                showStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Guardar cambios de permisos de propiedades
        async function savePropertyPermissions() {
            try {
                showStatus('üîÑ Guardando cambios de permisos de propiedades...', 'success');

                const checkboxes = document.querySelectorAll('#property-permissions-grid input[type="checkbox"]');
                const changes = [];

                checkboxes.forEach(checkbox => {
                    const propertyId = checkbox.dataset.propertyId;
                    const accessId = checkbox.dataset.accessId;
                    const isChecked = checkbox.checked;
                    const hadAccess = accessId && accessId !== '';
                    const accessType = document.getElementById(`access_type_${propertyId}`).value;

                    if (isChecked && !hadAccess) {
                        // Necesita otorgar acceso
                        changes.push({
                            type: 'grant',
                            property_id: propertyId,
                            access_type: accessType
                        });
                    } else if (!isChecked && hadAccess) {
                        // Necesita revocar acceso
                        changes.push({
                            type: 'revoke',
                            access_id: accessId
                        });
                    } else if (isChecked && hadAccess) {
                        // Verificar si cambi√≥ el tipo de acceso
                        const currentAccessType = checkbox.closest('div').querySelector('select').value;
                        // Para simplificar, siempre actualizamos si est√° marcado y ya ten√≠a acceso
                        changes.push({
                            type: 'update',
                            access_id: accessId,
                            property_id: propertyId,
                            access_type: currentAccessType
                        });
                    }
                });

                console.log('üìù Cambios de propiedades detectados:', changes);

                if (changes.length === 0) {
                    showStatus('‚ÑπÔ∏è No hay cambios que guardar en propiedades', 'success');
                    return;
                }

                // Aplicar cambios
                let successCount = 0;
                let errorCount = 0;

                for (const change of changes) {
                    try {
                        if (change.type === 'grant' || change.type === 'update') {
                            const response = await authenticatedFetch('/en/api/v1/permissions/admin/grant_property_access/', {
                                method: 'POST',
                                body: JSON.stringify({
                                    user_id: currentUser.decoded.user_id,
                                    property_id: change.property_id,
                                    access_type: change.access_type,
                                    permissions: {
                                        can_create_shifts: true,
                                        can_edit_shifts: true,
                                        can_create_expenses: true,
                                        can_edit_expenses: true,
                                        can_approve_expenses: change.access_type === 'admin' || change.access_type === 'full'
                                    },
                                    reason: 'Modificado desde interface de checkboxes'
                                })
                            });

                            if (response && response.ok) {
                                successCount++;
                                const result = await response.json();
                                logPermissionChange('granted', result);
                            } else {
                                errorCount++;
                                console.error('Error otorgando/actualizando acceso:', change);
                            }
                        } else if (change.type === 'revoke') {
                            const response = await authenticatedFetch('/en/api/v1/permissions/admin/revoke_property_access/', {
                                method: 'POST',
                                body: JSON.stringify({
                                    access_id: change.access_id,
                                    reason: 'Revocado desde interface de checkboxes'
                                })
                            });

                            if (response && response.ok) {
                                successCount++;
                                const result = await response.json();
                                logPermissionChange('revoked', result);
                            } else {
                                errorCount++;
                                console.error('Error revocando acceso:', change);
                            }
                        }
                    } catch (error) {
                        errorCount++;
                        console.error('Error procesando cambio de propiedad:', error, change);
                    }
                }

                if (errorCount === 0) {
                    showStatus(`‚úÖ Todos los cambios de propiedades guardados exitosamente (${successCount} cambios)`, 'success');
                } else {
                    showStatus(`‚ö†Ô∏è ${successCount} cambios exitosos, ${errorCount} errores en propiedades`, 'error');
                }

                // Recargar el grid para reflejar los cambios
                setTimeout(() => loadPropertyPermissionsGrid(), 1000);

            } catch (error) {
                console.error('‚ùå Error guardando permisos de propiedades:', error);
                showStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Refrescar permisos del usuario (relogin autom√°tico)
        async function refreshUserPermissions() {
            if (!currentTokens) {
                showStatus('‚ùå No hay sesi√≥n activa', 'error');
                return;
            }

            showStatus('üîÑ Refrescando permisos...', 'success');

            // Obtener las credenciales actuales
            const username = currentUser.getUsername();
            const password = prompt('Ingresa tu contrase√±a para obtener un token actualizado:');

            if (!password) {
                showStatus('‚ùå Contrase√±a requerida para refrescar permisos', 'error');
                return;
            }

            try {
                // Hacer login nuevamente para obtener token actualizado
                const response = await fetch(`${API_BASE_URL}/auth/login/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                if (response.ok) {
                    const tokens = await response.json();
                    currentTokens = tokens;

                    // Decodificar el nuevo token
                    const decodedToken = decodeJWT(tokens.access);
                    if (decodedToken) {
                        currentUser = new PermissionHelper(decodedToken);

                        // Actualizar todas las secciones
                        showPermissions();
                        updateActionButtons();
                        showToken();
                        loadCurrentPermissions();

                        showStatus('‚úÖ Permisos actualizados! Token refrescado con nuevos permisos', 'success');
                    }
                } else {
                    showStatus('‚ùå Error refrescando token. Verifica tu contrase√±a', 'error');
                }
            } catch (error) {
                console.error('‚ùå Error refrescando permisos:', error);
                showStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Log de cambios de permisos
        function logPermissionChange(action, result) {
            const logContainer = document.getElementById('permission-log');
            const timestamp = new Date().toLocaleString();

            let logEntry = `<div style="margin: 5px 0; padding: 8px; background: ${action === 'granted' ? '#d4edda' : '#f8d7da'}; border-radius: 4px; border-left: 4px solid ${action === 'granted' ? '#28a745' : '#dc3545'};">
                <strong>${timestamp}</strong> - ${action === 'granted' ? '‚úÖ Otorgado' : '‚ùå Revocado'}: ${result.message || JSON.stringify(result)}
            </div>`;

            logContainer.innerHTML = logEntry + logContainer.innerHTML;
        }

        // ===============================================
        // üìã FUNCIONES PRINCIPALES DEL DEMO
        // ===============================================

        function showDashboard() {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');

            const userInfo = document.getElementById('user-info');
            userInfo.innerHTML = `
                <div class="status success">
                    <strong>Bienvenido, ${currentUser.getUsername()}!</strong><br>
                    Rol: ${currentUser.getRole()}<br>
                    Admin: ${currentUser.isAdmin() ? 'S√≠' : 'No'}
                </div>
            `;

            // Mostrar secci√≥n de admin si es administrador
            if (currentUser.isAdmin()) {
                document.getElementById('admin-section').classList.remove('hidden');
                document.getElementById('current-user-display').textContent = currentUser.getUsername();
                loadAdminData();
            }
        }

        function showPermissions() {
            document.getElementById('permissions-section').classList.remove('hidden');

            const content = document.getElementById('permissions-content');
            const resourcePerms = currentUser.decoded.resource_permissions;

            let html = '<div class="permissions-grid">';

            // Mostrar permisos por recurso
            for (const [resource, actions] of Object.entries(resourcePerms)) {
                html += `
                    <div class="permission-card">
                        <h3>üìã ${resource.toUpperCase()}</h3>
                        <ul class="permission-list">
                `;

                actions.forEach(action => {
                    html += `<li>‚úÖ ${action}</li>`;
                });

                html += '</ul></div>';
            }

            // Mostrar propiedades accesibles
            const props = currentUser.getAccessibleProperties();
            html += `
                <div class="permission-card">
                    <h3>üè¢ PROPIEDADES ACCESIBLES</h3>
                    <ul class="permission-list">
            `;

            if (props.length > 0) {
                props.forEach(propId => {
                    html += `<li>üè† Propiedad ${propId}</li>`;
                });
            } else {
                html += '<li>‚ùå Sin acceso a propiedades</li>';
            }

            html += '</ul></div></div>';
            content.innerHTML = html;
        }

        function updateActionButtons() {
            document.getElementById('actions-section').classList.remove('hidden');

            // Botones de clientes
            updateButton('btn-create-client', currentUser.canCreateClients());
            updateButton('btn-read-client', currentUser.canReadClients());
            updateButton('btn-update-client', currentUser.canUpdateClients());
            updateButton('btn-delete-client', currentUser.canDeleteClients());

            // Botones de guardias
            updateButton('btn-create-guard', currentUser.canCreateGuards());
            updateButton('btn-read-guard', currentUser.canReadGuards());
            updateButton('btn-assign-guard', currentUser.canAssignGuards());
            updateButton('btn-update-guard', currentUser.canUpdateGuards());

            // Botones de gastos
            updateButton('btn-create-expense', currentUser.canCreateExpenses());
            updateButton('btn-read-expense', currentUser.canReadExpenses());
            updateButton('btn-approve-expense', currentUser.canApproveExpenses());
            updateButton('btn-update-expense', currentUser.canUpdateExpenses());

            // Lista de propiedades
            const propertiesList = document.getElementById('properties-list');
            const props = currentUser.getAccessibleProperties();

            if (props.length > 0) {
                let html = '';
                for (let i = 1; i <= 5; i++) {
                    const canAccess = currentUser.canAccessProperty(i);
                    html += `
                        <button class="btn ${canAccess ? 'btn-success' : 'btn-secondary'}"
                                ${!canAccess ? 'disabled' : ''}
                                onclick="simulateAction('access-property-${i}')">
                            ${canAccess ? 'üè†' : 'üö´'} Propiedad ${i}
                        </button><br><br>
                    `;
                }
                propertiesList.innerHTML = html;
            } else {
                propertiesList.innerHTML = '<p>‚ùå Sin acceso a propiedades</p>';
            }
        }

        function updateButton(buttonId, enabled) {
            const button = document.getElementById(buttonId);
            button.disabled = !enabled;
            if (!enabled) {
                button.title = 'Sin permisos para esta acci√≥n';
            }
        }

        function showToken() {
            document.getElementById('token-section').classList.remove('hidden');
            const tokenDisplay = document.getElementById('token-display');
            tokenDisplay.innerHTML = JSON.stringify(currentUser.decoded, null, 2);
        }

        function simulateAction(action) {
            if (!currentTokens) {
                showStatus('‚ùå No hay sesi√≥n activa', 'error');
                return;
            }

            showStatus(`üéØ Ejecutando acci√≥n real: ${action}`, 'success');

            // Aqu√≠ podr√≠as agregar llamadas reales a la API seg√∫n la acci√≥n
            switch(action) {
                case 'create-client':
                    if (currentUser.canCreateClients()) {
                        createRealClient();
                    }
                    break;
                case 'read-client':
                    if (currentUser.canReadClients()) {
                        loadRealClients();
                    }
                    break;
                case 'read-guard':
                    if (currentUser.canReadGuards()) {
                        loadRealGuards();
                    }
                    break;
                default:
                    showStatus(`‚ÑπÔ∏è Acci√≥n ${action} simulada (implementa seg√∫n necesidad)`, 'success');
            }
        }

        // Funciones para acciones reales
        async function createRealClient() {
            try {
                const clientData = {
                    name: 'Cliente Demo',
                    email: 'demo@ejemplo.com',
                    phone: '123456789'
                };

                const response = await authenticatedFetch(`${API_BASE_URL}/clients/`, {
                    method: 'POST',
                    body: JSON.stringify(clientData)
                });

                if (response && response.ok) {
                    const newClient = await response.json();
                    showStatus(`‚úÖ Cliente creado: ${newClient.name}`, 'success');
                } else {
                    showStatus('‚ùå Error creando cliente', 'error');
                }
            } catch (error) {
                showStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function loadRealClients() {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/clients/`);
                if (response && response.ok) {
                    const clients = await response.json();
                    const count = clients.results ? clients.results.length : clients.length;
                    showStatus(`üìä Clientes cargados: ${count}`, 'success');
                } else {
                    showStatus('‚ùå Error cargando clientes', 'error');
                }
            } catch (error) {
                showStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function loadRealGuards() {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/guards/`);
                if (response && response.ok) {
                    const guards = await response.json();
                    const count = guards.results ? guards.results.length : guards.length;
                    showStatus(`üõ°Ô∏è Guardias cargados: ${count}`, 'success');
                } else {
                    showStatus('‚ùå Error cargando guardias', 'error');
                }
            } catch (error) {
                showStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        function showStatus(message, type) {
            // Crear o actualizar elemento de status
            let statusDiv = document.getElementById('status-message');
            if (!statusDiv) {
                statusDiv = document.createElement('div');
                statusDiv.id = 'status-message';
                document.body.insertBefore(statusDiv, document.body.firstChild);
            }

            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;

            // Auto-ocultar despu√©s de 3 segundos
            setTimeout(() => {
                if (statusDiv.parentNode) {
                    statusDiv.parentNode.removeChild(statusDiv);
                }
            }, 3000);
        }

        // Mostrar mensaje inicial
        showStatus('ÔøΩ ¬°Demo REAL conectado al backend! Usa credenciales reales para hacer login.', 'success');
    </script>
</body>
</html>
